{% comment %}
Page template for Test Page
- Includes Banner section (banner.liquid)
- Includes Grid section (grid.liquid)
- Handles popup functionality for product quick view
{% endcomment %}

{% layout none %}

<!doctype html>
<html lang="en">
<head>
  <meta charset="utf-8">
  <title>{{ page.title }}</title>
  {{ content_for_header }}
  <style>
    /* Basic popup styling */
    .popup-overlay {
      position: fixed;
      top: 0; left: 0; right: 0; bottom: 0;
      background: rgba(0,0,0,0.6);
      display: none;
      align-items: center;
      justify-content: center;
      z-index: 999;
    }
    .popup-content {
      background: #fff;
      padding: 20px;
      max-width: 500px;
      width: 90%;
      border-radius: 8px;
      position: relative;
    }
    .popup-close {
      position: absolute;
      top: 10px; right: 10px;
      cursor: pointer;
      font-size: 18px;
    }
  </style>
</head>
<body>
  <main id="MainContent">
    {% section 'banner' %}
    {% section 'grid' %}
  </main>

  <!-- Popup -->
  <div id="product-popup" class="popup-overlay">
    <div class="popup-content">
      <span class="popup-close">&times;</span>
      <h2 id="popup-title"></h2>
      <p id="popup-price"></p>
      <div id="popup-description"></div>
      <form id="popup-form">
        <div id="popup-variants"></div>
        <button type="submit">Add to Cart</button>
      </form>
    </div>
  </div>

  {{ content_for_footer }}

  <script>
    document.addEventListener("DOMContentLoaded", function() {
      const popup = document.getElementById("product-popup");
      const popupTitle = document.getElementById("popup-title");
      const popupPrice = document.getElementById("popup-price");
      const popupDescription = document.getElementById("popup-description");
      const popupVariants = document.getElementById("popup-variants");
      const popupForm = document.getElementById("popup-form");

      // Close popup
      document.querySelector(".popup-close").addEventListener("click", () => {
        popup.style.display = "none";
      });

      // Listen for grid product clicks
      document.querySelectorAll("[data-product]").forEach(btn => {
        btn.addEventListener("click", async () => {
          const handle = btn.dataset.product;
          const res = await fetch(`/products/${handle}.js`);
          const product = await res.json();

          popupTitle.textContent = product.title;
          popupPrice.textContent = `$${(product.price/100).toFixed(2)}`;
          popupDescription.textContent = product.description;

          // Render variants
          popupVariants.innerHTML = "";
          product.variants.forEach(variant => {
            const radio = document.createElement("input");
            radio.type = "radio";
            radio.name = "variant";
            radio.value = variant.id;
            if (variant.available) {
              popupVariants.appendChild(radio);
              popupVariants.appendChild(document.createTextNode(variant.title));
              popupVariants.appendChild(document.createElement("br"));
            }
          });

          popup.style.display = "flex";
        });
      });

      // Add to cart
      popupForm.addEventListener("submit", async (e) => {
        e.preventDefault();
        const variantId = popupForm.querySelector("input[name='variant']:checked").value;

        // Add chosen product
        await fetch("/cart/add.js", {
          method: "POST",
          headers: { "Content-Type": "application/json" },
          body: JSON.stringify({ id: variantId, quantity: 1 })
        });

        // Auto add "Soft Winter Jacket" if Black & Medium chosen
        const selectedText = popupForm.querySelector("input[name='variant']:checked").nextSibling.textContent;
        if (selectedText.includes("Black") && selectedText.includes("Medium")) {
          const res = await fetch(`/products/soft-winter-jacket.js`);
          const jacket = await res.json();
          await fetch("/cart/add.js", {
            method: "POST",
            headers: { "Content-Type": "application/json" },
            body: JSON.stringify({ id: jacket.variants[0].id, quantity: 1 })
          });
        }

        alert("Added to cart!");
        popup.style.display = "none";
      });
    });
  </script>
</body>
</html>


{% layout 'theme' %}
{% section 'banner' %}
{% section 'grid' %}